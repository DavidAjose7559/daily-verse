<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Verse</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <main class="container">
    <header class="page-header">
      <h1 id="reference" class="title">Daily Verse</h1>
      <div class="meta">
        <span id="date">Date: —</span>
        <span class="dot">·</span>
        <span id="translation">WEB</span>
      </div>
      <p id="text" class="verse-text"></p>

      <div class="actions">
        <button id="copyBtn" class="btn">Copy Verse</button>
        <button id="shareBtn" class="btn btn-ghost">Share</button>
        <!-- New: archive navigation -->
        <button id="prevBtn" class="btn btn-ghost">Yesterday</button>
        <button id="todayBtn" class="btn" style="display:none">Today</button>
      </div>
    </header>

    <article id="context" class="card" aria-live="polite"></article>

    <!-- Dev-only debug (keep hidden or remove later) -->
    <pre id="debug" style="display:none;"></pre>
  </main>

  <script>
    // ==============================
    // CONFIG: API lives on Render
    // ==============================
    const API_BASE = 'https://daily-verse-viewer.onrender.com';

    // ==============================
    // DOM refs
    // ==============================
    const els = {
      date:        document.getElementById('date'),
      reference:   document.getElementById('reference'),
      text:        document.getElementById('text'),
      context:     document.getElementById('context'),
      translation: document.getElementById('translation'),
      copyBtn:     document.getElementById('copyBtn'),
      shareBtn:    document.getElementById('shareBtn'),
      prevBtn:     document.getElementById('prevBtn'),
      todayBtn:    document.getElementById('todayBtn'),
      debug:       document.getElementById('debug'),
    };

    // ==============================
    // Minimal sanitization
    // ==============================
    function stripScripts(html) {
      const div = document.createElement('div');
      div.innerHTML = html || '';
      div.querySelectorAll('script').forEach(s => s.remove());
      return div.innerHTML;
    }

    // ==============================
    // Rendering helpers
    // ==============================
    function renderPayload(d) {
      els.date.textContent        = `Date: ${d.date || '—'}`;
      els.reference.textContent   = d.reference || 'Daily Verse';
      els.text.textContent        = d.text || '';
      els.translation.textContent = d.translation || 'WEB';
      els.context.innerHTML       = stripScripts(d.context);
    }

    // Toronto date helpers (YYYY-MM-DD without libs)
    function torontoISO(date = new Date()) {
      const fmt = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/Toronto',
        year: 'numeric', month: '2-digit', day: '2-digit'
      });
      const parts = Object.fromEntries(fmt.formatToParts(date).map(p => [p.type, p.value]));
      return `${parts.year}-${parts.month}-${parts.day}`;
    }
    function torontoYesterdayISO() {
      const [y, m, d] = torontoISO().split('-').map(Number);
      const dt = new Date(Date.UTC(y, m - 1, d));
      dt.setUTCDate(dt.getUTCDate() - 1);
      const yy = dt.getUTCFullYear();
      const mm = String(dt.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(dt.getUTCDate()).padStart(2, '0');
      return `${yy}-${mm}-${dd}`;
    }

    // ==============================
    // Fetch + render (Today)
    // ==============================
    async function loadDaily() {
      try {
        const res = await fetch(`${API_BASE}/api/daily`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const d = await res.json();
        renderPayload(d);
        // toggle nav buttons for "today" view
        els.todayBtn.style.display = 'none';
        els.prevBtn.style.display = 'inline-block';
        els.prevBtn.disabled = false;
        // Uncomment for debugging:
        // els.debug.style.display = 'block';
        // els.debug.textContent = JSON.stringify(d.rating, null, 2);
      } catch (e) {
        if (els.debug) {
          els.debug.style.display = 'block';
          els.debug.textContent = `Not ready (${e.message})`;
        }
      }
    }

    // ==============================
    // Fetch + render (Yesterday)
    // ==============================
    async function loadYesterday() {
      const y = torontoYesterdayISO();
      try {
        const res = await fetch(`${API_BASE}/api/archive/${y}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`No archive for ${y}`);
        const d = await res.json();
        renderPayload(d);
        // toggle nav buttons for "yesterday" view
        els.prevBtn.style.display = 'none';
        els.todayBtn.style.display = 'inline-block';
      } catch (e) {
        alert('No saved verse for yesterday yet.'); // could be the first day running
      }
    }

    // ==============================
    // Copy & Share
    // ==============================
    els.copyBtn.addEventListener('click', async () => {
      const content = `${els.reference.textContent} — ${els.text.textContent}`;
      try {
        await navigator.clipboard.writeText(content);
        alert('Verse copied!');
      } catch {
        alert('Copy failed');
      }
    });

    els.shareBtn.addEventListener('click', async () => {
      const content = `${els.reference.textContent} — ${els.text.textContent}`;
      if (navigator.share) {
        try {
          await navigator.share({ title: 'Daily Verse', text: content, url: location.href });
        } catch { /* user cancelled or share failed */ }
      } else {
        alert('Sharing not supported in this browser');
      }
    });

    // Archive nav
    els.prevBtn.addEventListener('click', loadYesterday);
    els.todayBtn.addEventListener('click', loadDaily);

    // On load, disable "Yesterday" if no archive yet
    (async () => {
      try {
        const res = await fetch(`${API_BASE}/api/archive`, { cache: 'no-store' });
        const list = res.ok ? await res.json() : [];
        const hasYesterday = list.some(x => x.date === torontoYesterdayISO());
        if (!hasYesterday) els.prevBtn.disabled = true;
      } catch {
        els.prevBtn.disabled = true;
      }
    })();

    // ==============================
    // Refresh at next midnight (Toronto)
    // ==============================
    function msUntilNextMidnightToronto() {
      const now = new Date();
      const fmt = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/Toronto',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      });
      const parts = Object.fromEntries(fmt.formatToParts(now).map(p => [p.type, p.value]));
      const torontoNow = new Date(`${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`);
      const next = new Date(torontoNow);
      next.setDate(next.getDate() + 1);
      next.setHours(0, 0, 0, 0);
      return next - torontoNow;
    }

    // First load immediately
    loadDaily();

    // Refresh once at next midnight, then every 24h
    setTimeout(() => {
      loadDaily();
      setInterval(loadDaily, 24 * 60 * 60 * 1000);
    }, msUntilNextMidnightToronto());
  </script>
</body>
</html>
