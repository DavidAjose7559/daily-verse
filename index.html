<script>
  // CHANGE 1: make API base portable (same-origin)
  const API_BASE = ''; // was 'https://daily-verse-viewer.onrender.com'

  const els = {
    date:        document.getElementById('date'),
    reference:   document.getElementById('reference'),
    text:        document.getElementById('text'),
    context:     document.getElementById('context'),
    translation: document.getElementById('translation'),
    debug:       document.getElementById('debug'),
    copyBtn:     document.getElementById('copyBtn'),
    shareBtn:    document.getElementById('shareBtn'),
  };

  function stripScripts(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    div.querySelectorAll('script').forEach(s => s.remove());
    return div.innerHTML;
  }

  async function loadDaily() {
    try {
      const res = await fetch(`${API_BASE}/api/daily`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const d = await res.json();

      els.date.textContent = `Date: ${d.date || '—'}`;
      els.reference.textContent = d.reference || 'Daily Verse';
      els.text.textContent = d.text || '';
      els.translation.textContent = d.translation || 'WEB';
      els.context.innerHTML = d.context ? stripScripts(d.context) : '';

      // dev debug (safe to keep commented)
      // if (els.debug) els.debug.textContent = d.rating ? JSON.stringify(d.rating, null, 2) : '';
    } catch (e) {
      if (els.debug) els.debug.textContent = `Not ready yet (${e.message}).`;
    }
  }

  els.copyBtn.addEventListener('click', async () => {
    const content = `${els.reference.textContent} — ${els.text.textContent}`;
    try {
      await navigator.clipboard.writeText(content);
      alert('Verse copied!');
    } catch {
      alert('Copy failed');
    }
  });

  els.shareBtn.addEventListener('click', async () => {
    const content = `${els.reference.textContent} — ${els.text.textContent}`;
    if (navigator.share) {
      try {
        await navigator.share({ title: 'Daily Verse', text: content, url: window.location.href });
      } catch { /* user cancelled or share failed */ }
    } else {
      alert('Sharing not supported in this browser');
    }
  });

  // initial load + dev polling (remove setInterval in prod if you want)
  loadDaily();
  setInterval(loadDaily, 60_000);
</script>
