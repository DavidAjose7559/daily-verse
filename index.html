<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ“–Daily Verse</title>
  <!-- optional: your existing stylesheet -->
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* tiny defaults if you don't have a stylesheet */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; line-height: 1.6; }
    .meta { color: #666; margin-bottom: 1rem; }
    .actions { display: flex; gap: .5rem; margin: 1rem 0 2rem; }
    .actions button { padding: .6rem .9rem; border-radius: .6rem; border: 1px solid #ddd; background: #f8f8f8; cursor: pointer; }
    .actions button:hover { background: #f1f1f1; }
    #debug { opacity: .6; font-size: .82rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <main>
    <h1 id="reference">Daily Verse</h1>
    <div class="meta">
      <span id="date">Date: â€”</span>
      <span aria-hidden="true"> Â· </span>
      <span id="translation">WEB</span>
    </div>

    <p id="text"></p>

    <div class="actions">
      <button id="copyBtn" type="button">ðŸ“‹ Copy Verse</button>
      <button id="shareBtn" type="button">ðŸ”— Share</button>
    </div>

    <section id="context" aria-live="polite"></section>

    <!-- dev-only: comment out or remove in prod -->
    <pre id="debug"></pre>
  </main>

  <script>
    const els = {
      date:        document.getElementById('date'),
      reference:   document.getElementById('reference'),
      text:        document.getElementById('text'),
      context:     document.getElementById('context'),
      translation: document.getElementById('translation'),
      debug:       document.getElementById('debug'),
      copyBtn:     document.getElementById('copyBtn'),
      shareBtn:    document.getElementById('shareBtn'),
    };

    // lightweight guard: strip any <script> tags before inserting HTML
    function stripScripts(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      div.querySelectorAll('script').forEach(s => s.remove());
      return div.innerHTML;
    }

    async function loadDaily() {
      try {
        const res = await fetch('/api/daily', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const d = await res.json();

        // update UI
        els.date.textContent = `Date: ${d.date || 'â€”'}`;
        els.reference.textContent = d.reference || 'Daily Verse';
        els.text.textContent = d.text || '';
        els.translation.textContent = d.translation || 'WEB';
        els.context.innerHTML = d.context ? stripScripts(d.context) : '';

        // show rating while testing (optional)
        if (els.debug) {
          const rating = d.rating ? JSON.stringify(d.rating, null, 2) : '';
          els.debug.textContent = rating;
        }
      } catch (e) {
        if (els.debug) els.debug.textContent = `Not ready yet (${e.message}).`;
      }
    }

    // Copy verse text + reference
    els.copyBtn.addEventListener('click', async () => {
      const content = `${els.reference.textContent} â€” ${els.text.textContent}`;
      try {
        await navigator.clipboard.writeText(content);
        alert('Verse copied!');
      } catch {
        alert('Copy failed');
      }
    });

    // Web Share API (falls back to alert if unsupported)
    els.shareBtn.addEventListener('click', async () => {
      const content = `${els.reference.textContent} â€” ${els.text.textContent}`;
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Daily Verse',
            text: content,
            url: window.location.href
          });
        } catch {
          /* user cancelled or share failed */
        }
      } else {
        alert('Sharing not supported in this browser');
      }
    });

    // initial load + dev polling (safe to remove for production)
    loadDaily();
    setInterval(loadDaily, 60_000);
  </script>
</body>
</html>
