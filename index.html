<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Verse â€” Today</title>

  <!-- Basic SEO -->
  <meta name="description" content="Receive a daily verse with faithful context, explanation, and Greek insights." />
  <link rel="canonical" href="https://davidajose7559.github.io/daily-verse/" />
  <meta name="theme-color" content="#2563eb" />

  <!-- Open Graph -->
  <meta property="og:title" content="Daily Verse â€” Today" />
  <meta property="og:description" content="Faithful daily verses with context and explanation." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://davidajose7559.github.io/daily-verse/DA.png" />

  <!-- Fonts & Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />

  <!-- Plausible -->
  <script defer data-domain="davidajose7559.github.io" src="https://plausible.io/js/script.outbound-links.js"></script>
</head>

<body>
  <main>
    <header>
      <h1 id="reference">Loading...</h1>
      <p id="date"></p>
      <p id="verse"></p>
      <div class="buttons">
        <button id="copyBtn" class="btn">Copy Verse</button>
        <button id="shareBtn" class="btn">Share</button>
        <button id="yesterdayBtn" class="btn">Yesterday</button>
        <a href="archive.html" class="btn">Archive</a>
        <button id="themeToggle" class="btn" title="Toggle theme">ðŸŒ™</button>
      </div>
    </header>

    <section id="context" class="card">
      <p>Loading explanation...</p>
    </section>
  </main>

  <footer>
    <p><strong>Daily Verse</strong> â€” faithfully explained and contextualized.</p>
  </footer>

  <script>
    const API_BASE = (location.hostname.endsWith('github.io'))
      ? 'https://daily-verse-api.onrender.com'
      : location.origin;

    const refEl = document.getElementById('reference');
    const dateEl = document.getElementById('date');
    const verseEl = document.getElementById('verse');
    const contextEl = document.getElementById('context');

    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') document.body.classList.add('light');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });

    // Load verse
    async function loadVerse() {
      const urlParams = new URLSearchParams(location.search);
      const dateParam = urlParams.get('date');
      const endpoint = dateParam ? `/api/archive/${dateParam}` : '/api/daily';
      try {
        const res = await fetch(API_BASE + endpoint);
        if (!res.ok) throw new Error('Fetch failed');
        const payload = await res.json();
        renderVerse(payload);
      } catch (err) {
        refEl.textContent = 'Error loading verse';
        contextEl.innerHTML = '<p>Could not load todayâ€™s verse. Please try again later.</p>';
      }
    }

    // Render the verse data
    function renderVerse(payload) {
      refEl.textContent = payload.reference;
      dateEl.textContent = `Date: ${payload.date} Â· ${payload.translation}`;
      verseEl.textContent = payload.text;
      contextEl.innerHTML = payload.context;

      // Set up extended toggle
      setupExtendedToggle(payload);

      // JSON-LD for SEO
      const ld = {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": `Daily Verse â€” ${payload.reference}`,
        "datePublished": payload.date,
        "articleBody": payload.text,
        "author": { "@type": "Organization", "name": "Daily Verse" }
      };
      const script = document.createElement('script');
      script.type = 'application/ld+json';
      script.textContent = JSON.stringify(ld, null, 2);
      document.head.appendChild(script);
    }

    // Copy / Share / Yesterday buttons
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const text = `${refEl.textContent}\n${verseEl.textContent}`;
      try {
        await navigator.clipboard.writeText(text);
        alert('Verse copied!');
      } catch {}
    });

    document.getElementById('shareBtn').addEventListener('click', async () => {
      const shareData = {
        title: refEl.textContent,
        text: verseEl.textContent,
        url: location.href
      };
      try {
        await navigator.share(shareData);
      } catch {}
    });

    document.getElementById('yesterdayBtn').addEventListener('click', () => {
      const today = new Date();
      today.setDate(today.getDate() - 1);
      const yDate = today.toISOString().split('T')[0];
      location.href = `?date=${yDate}`;
    });

    // --- Extended Passage Toggle Logic ---
    function setupExtendedToggle(payload) {
      try {
        if (!payload?.extended?.reference) return;
        const ctx = document.getElementById('context');
        if (!ctx) return;

        const headers = Array.from(ctx.querySelectorAll('h3'));
        const extH3 = headers.find(h => h.textContent.trim().toLowerCase() === 'extended verse');
        if (!extH3) return;
        const refP = extH3.nextElementSibling;
        if (!refP || refP.tagName !== 'P') return;

        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.style.marginTop = '8px';
        btn.textContent = 'Read extended passage';

        const box = document.createElement('div');
        box.style.display = 'none';
        box.style.marginTop = '10px';
        box.style.padding = '12px';
        box.style.border = '1px solid var(--border)';
        box.style.borderRadius = '12px';
        box.style.background = 'var(--muted)';

        if (payload.extended.text) {
          const pre = document.createElement('pre');
          pre.style.whiteSpace = 'pre-wrap';
          pre.style.margin = '0';
          pre.textContent = payload.extended.text;
          box.appendChild(pre);
        } else {
          box.textContent = 'Extended passage could not be loaded. Please try again later.';
        }

        btn.addEventListener('click', () => {
          const showing = box.style.display !== 'none';
          box.style.display = showing ? 'none' : 'block';
          btn.textContent = showing ? 'Read extended passage' : 'Hide extended passage';
        });

        refP.insertAdjacentElement('afterend', btn);
        btn.insertAdjacentElement('afterend', box);
      } catch {}
    }

    loadVerse();
  </script>
</body>
</html>
